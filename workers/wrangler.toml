# MemoryRouter Cloudflare Workers Configuration
# Deploys to: api.memoryrouter.ai

name = "memoryrouter-api"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# Enable workers.dev subdomain
workers_dev = true

# Development settings
[dev]
port = 8787

# ========== Durable Objects ==========

# Vault Durable Object — one per memory key per vault type
[durable_objects]
bindings = [
  { name = "VAULT_DO", class_name = "VaultDurableObject" }
]

# Migration: declare SQLite-backed DO class
[[migrations]]
tag = "v1"
new_sqlite_classes = ["VaultDurableObject"]

# ========== D1 Databases ==========
# D1 intermediate state — fast fallback for cold DO reads
[[d1_databases]]
binding = "VECTORS_D1"
database_name = "memoryrouter-vectors"
database_id = "4009299d-3c91-4c0f-b614-236e3c2c0d8b"

# ========== KV Namespaces ==========
# VECTORS_KV: Kept for migration period, then removed
# METADATA_KV: Kept permanently (auth, user data, billing)

[[kv_namespaces]]
binding = "VECTORS_KV"
id = "1e73c05d2cac424080e855cfd0d9c58e"

[[kv_namespaces]]
binding = "METADATA_KV"
id = "40652c48ae9141d9b3a8f797b39bb9f6"

[[kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "605174c879314703a6db473f0c6df2ac"

# ========== R2 Buckets ==========
# Cold backup for vault snapshots
[[r2_buckets]]
binding = "VECTORS_R2"
bucket_name = "memory-router"

# ========== Workers AI ==========
# BGE-M3 embeddings at edge (~18ms latency, $0.012/1M)
[ai]
binding = "AI"

# ========== Queues ==========
# Storage queue: decouples embedding/storage from inference
[[queues.producers]]
queue = "memoryrouter-storage"
binding = "STORAGE_QUEUE"

[[queues.consumers]]
queue = "memoryrouter-storage"
max_batch_size = 10
max_batch_timeout = 5

# ========== Cron Triggers ==========
# Daily: Calculate archival storage + purge old data (3 AM UTC)
# Monthly: Bill archival storage to Stripe (1st of month, 4 AM UTC)
[triggers]
crons = ["0 3 * * *", "0 4 1 * *"]

# ========== Environment Variables ==========
[vars]
ENVIRONMENT = "development"
# Embeddings: Cloudflare Workers AI BGE-M3 (1024 dims, ~18ms, $0.012/1M)
DEFAULT_EMBEDDING_DIMS = "1024"
HOT_WINDOW_HOURS = "4"
WORKING_WINDOW_DAYS = "3"
LONGTERM_WINDOW_DAYS = "90"
# Feature flag: use Durable Objects instead of KV+R2
USE_DURABLE_OBJECTS = "true"

# ========== STAGING ENVIRONMENT ==========
# Deploy: npx wrangler deploy --env staging
# URL: memoryrouter-staging.roodbiz.workers.dev

[env.staging]
name = "memoryrouter-staging"

# Staging D1 (separate from production)
[[env.staging.d1_databases]]
binding = "VECTORS_D1"
database_name = "memoryrouter-vectors-staging"
database_id = "925a348d-f89e-4ae5-aea6-2843ae0aba40"

# Staging shares KV with production (metadata/auth is the same)
[[env.staging.kv_namespaces]]
binding = "VECTORS_KV"
id = "1e73c05d2cac424080e855cfd0d9c58e"

[[env.staging.kv_namespaces]]
binding = "METADATA_KV"
id = "40652c48ae9141d9b3a8f797b39bb9f6"

[[env.staging.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "605174c879314703a6db473f0c6df2ac"

# Staging R2 (shared for now — could separate later)
[[env.staging.r2_buckets]]
binding = "VECTORS_R2"
bucket_name = "memory-router"

# Staging Durable Objects (isolated namespace)
[env.staging.durable_objects]
bindings = [
  { name = "VAULT_DO", class_name = "VaultDurableObject" }
]

# Staging queues
[[env.staging.queues.producers]]
queue = "memoryrouter-storage-staging"
binding = "STORAGE_QUEUE"

[[env.staging.queues.consumers]]
queue = "memoryrouter-storage-staging"
max_batch_size = 10
max_batch_timeout = 5

# Staging Workers AI binding
[env.staging.ai]
binding = "AI"

[env.staging.vars]
ENVIRONMENT = "staging"
USE_DURABLE_OBJECTS = "true"
DEFAULT_EMBEDDING_DIMS = "1024"
HOT_WINDOW_HOURS = "4"
WORKING_WINDOW_DAYS = "3"
LONGTERM_WINDOW_DAYS = "90"

# ========== PRODUCTION ENVIRONMENT ==========
# Deploy: npx wrangler deploy --env production
# URL: memoryrouter-api.roodbiz.workers.dev (or custom domain)

[env.production]
name = "memoryrouter-api"

# Production D1
[[env.production.d1_databases]]
binding = "VECTORS_D1"
database_name = "memoryrouter-vectors"
database_id = "4009299d-3c91-4c0f-b614-236e3c2c0d8b"

# Production KV
[[env.production.kv_namespaces]]
binding = "VECTORS_KV"
id = "1e73c05d2cac424080e855cfd0d9c58e"

[[env.production.kv_namespaces]]
binding = "METADATA_KV"
id = "40652c48ae9141d9b3a8f797b39bb9f6"

[[env.production.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "605174c879314703a6db473f0c6df2ac"

# Production R2
[[env.production.r2_buckets]]
binding = "VECTORS_R2"
bucket_name = "memory-router"

# Production Durable Objects
[env.production.durable_objects]
bindings = [
  { name = "VAULT_DO", class_name = "VaultDurableObject" }
]

# Production queues
[[env.production.queues.producers]]
queue = "memoryrouter-storage"
binding = "STORAGE_QUEUE"

[[env.production.queues.consumers]]
queue = "memoryrouter-storage"
max_batch_size = 10
max_batch_timeout = 5

# Production Workers AI binding
[env.production.ai]
binding = "AI"

[env.production.vars]
ENVIRONMENT = "production"
USE_DURABLE_OBJECTS = "true"
DEFAULT_EMBEDDING_DIMS = "1024"
HOT_WINDOW_HOURS = "4"
WORKING_WINDOW_DAYS = "3"
LONGTERM_WINDOW_DAYS = "90"
